@inject ICourseRepository CourseRepository
@inject ICourseRatingRepository CourseRatingRepository
@inject ISnackbar Snackbar
@inject NavigationManager Navigation
@inject IHttpContextAccessor httpContextAccessor

<MudItem @key="course">
    <MudLink Href="@("/course/" + course.Id.ToString())" Underline="Underline.None">
        <MudCard Elevation="0">
            <!-- khoa hoc -->
            <MudCardMedia Image="@($"images/CoursesImg/{course.Thumbnail}")" Height="200" />
            <MudCardContent>
                <MudText Typo="Typo.h6">@course.Name</MudText>
                <MudText Typo="Typo.caption">@course.Author</MudText>
                <!-- if length of description > 44 then just show 44 letters else show all-->
                @if (!string.IsNullOrEmpty(course.Description))
                {
                    @if (course.Description.Length > 44)
                    {
                        <MudText Typo="Typo.body2">@((MarkupString)(course.Description.Substring(0, 44) + "..."))</MudText>
                    }
                    else
                    {
                        <MudText Typo="Typo.body2">@((MarkupString)course.Description)</MudText>
                    }
                }
                <br />


            </MudCardContent>
            <MudDivider></MudDivider>
            <MudCardActions>
                <MudButton Variant="Variant.Text" Color="Color.Info">@course.Status</MudButton>
            </MudCardActions>
        </MudCard>
    </MudLink>
    @if (!httpContextAccessor.HttpContext.User.Identity.IsAuthenticated)
    {
        <MudRating @bind-SelectedValue="averageRate" ReadOnly="true"
                   Size="Size.Small"></MudRating>
        <span>
            @ratingToShow.ToString("#.##") (@allCourseRateCount)
        </span>
        <MudText Typo="Typo.body2" Class="font-italic">Vui lòng đăng nhập để vote!</MudText>
    }
    else
    {
        <MudRating @bind-SelectedValue="averageRate"
                   Size="Size.Small" @onclick="(() => HandleCourseRating(averageRate))"></MudRating>
        <span>
            @ratingToShow.ToString("#.##") (@allCourseRateCount)
        </span>
    }

</MudItem>

@code {

    [Parameter]
    public Course course { get; set; } = new Course();

    [CascadingParameter]
    Guid userId { get; set; }

    List<CourseRating> courseRatings { get; set; } = new List<CourseRating>();

    int allCourseRating { get; set; } = 0;

    int allCourseRateCount { get; set; } = 0;

    int averageRate { get; set; } = 0;

    double ratingToShow { get; set; } = 0;

    protected override void OnInitialized()
    {
        courseRatings = CourseRatingRepository.GetAllCourseRatingByCourseId(course.Id.ToString());
        if (courseRatings.Count > 0)
        {
            foreach (var item in courseRatings)
            {
                allCourseRating += item.TotalRating;
                allCourseRateCount += item.RateCount;
                averageRate = (int)allCourseRating / allCourseRateCount;
                ratingToShow = allCourseRating / allCourseRateCount;
            }
        }
    }

    void HandleCourseRating(int value)
    {
        if (value > 0)
        {
            if (!courseRatings.Any(x => x.UserId == this.userId))
            {
                CourseRating newCourseRating = new CourseRating
                {
                    CourseId = course.Id,
                    UserId = this.userId,
                    TotalRating = value,
                    RateCount = 1
                };
                CourseRatingRepository.CreateNewRating(newCourseRating);
            }
            else
            {
                CourseRating currentCourseRating = courseRatings.Where(x => x.UserId == this.userId).FirstOrDefault();
                CourseRatingRepository.UpdateRating(currentCourseRating, value);
            }
            Snackbar.Add("Vote thành công!", Severity.Success);


        }
        Navigation.NavigateTo("/", true);
    }
}
