@page "/admin/course-type-manager"
@attribute [Authorize(Roles = "Admin")]
@inject ICourseTypeRepository CourseTypeRepository
@inject ICourseRepository CourseRepository
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject NavigationManager Navigation 

<MudGrid>
    <MudItem lg="6">
        <MudPaper Class="p-3">
            <MudGrid>
                <MudItem lg="12">
                    <MudText Color="Color.Success">Thêm nhóm khóa học</MudText>
                </MudItem>
                <MudItem lg="9">
                    <MudTextField @bind-Value="newCourseType.Name" Label="Tên nhóm khóa học"
                                  Variant="Variant.Outlined"
                                  Margin="Margin.Dense">
                    </MudTextField>
                </MudItem>
                <MudItem lg="3">
                    <MudIconButton Icon="@Icons.Material.Outlined.AddCircleOutline"
                                   Color="@Color.Success" @onclick="Add" />
                </MudItem>
            </MudGrid>
        </MudPaper>
    </MudItem>
    <MudItem lg="12">
        <MudPaper Class="p-3">
            <MudSimpleTable Hover="true" Bordered="true">
                <thead>
                    <tr>
                        <td class="text-center font-weight-bold">Tên nhóm khóa học</td>
                        <td></td>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var context in courseTypes)
                    {
                        <tr @key="context">
                            <td>
                                <MudTextField @bind-Value="context.Name" Variant="Variant.Outlined"
                                              Margin="Margin.Dense" Required="true" @onfocusout="(() => Edit(context))"></MudTextField>
                            </td>
                            <td class="text-center">
                                <MudButton Color="Color.Error" @onclick="(() => DeleteAsync(context))">Delete</MudButton>
                            </td>
                        </tr>
                    }
                </tbody>
            </MudSimpleTable>

        </MudPaper>
    </MudItem>
</MudGrid>

@code {

    CourseType newCourseType = new();

    List<CourseType> courseTypes = new();

    List<Course> courses { get; set; }

    protected override void OnInitialized()
    {

        courseTypes = CourseTypeRepository.GetAllCourseType();
        courses = CourseRepository.GetAllCourse();
    }

    void Add()
    {
        if (!string.IsNullOrWhiteSpace(newCourseType.Name))
        {
            CourseTypeRepository.AddCourseType(newCourseType);
            Snackbar.Add("Thêm nhóm bài học thành công !", Severity.Success);
            newCourseType = new();
        }

        courseTypes = CourseTypeRepository.GetAllCourseType();

    }

    void Edit(CourseType courseType)
    {
        CourseType currentCourseType = CourseTypeRepository.GetSingleCourseType(courseType.Id.ToString());

        if (currentCourseType.Name != courseType.Name)
        {
            CourseTypeRepository.UpdateCourseType(courseType);
            Snackbar.Add("Thay đổi thành công!", Severity.Success);
        }

    }


    async Task DeleteAsync(CourseType courseType)
    {
        var dialog = DialogService.Show<DeleteDialog>("Xóa loại khóa học");
        var result = await dialog.Result;
        if (!result.Cancelled)
        {
            if (courses.Any(x => x.CourseTypeId == courseType.Id))
            {
                Snackbar.Add("Bạn phải xóa hết tất cả các khóa học trong loại khóa học này trước!", Severity.Warning);
            }
            else
            {
                CourseTypeRepository.DeleteCourseType(courseType);
                courseTypes = CourseTypeRepository.GetAllCourseType();

            }
        }
    }

}
