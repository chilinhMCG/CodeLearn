@page "/admin/course-detail/edit/{id}"
@attribute [Authorize(Roles = "Admin")]
@inject ICourseRepository CourseRepository
@inject ICourseDetailRepository CourseDetailRepository
@inject IUserRepository UserRepository
@inject IJSRuntime JSRuntime

<MudPaper Class="p-4">
    <MudItem>
        <MudText Class="text-center" Color="Color.Success" Typo="Typo.h3">Chỉnh sửa bài học</MudText>
    </MudItem>
</MudPaper>
<br />
<MudPaper Class="m-auto p-4">
    <MudForm Model="currentCourseDetail" @bind-IsValid="formSuccess">
        <MudItem>
            <MudTextField Margin="Margin.Dense" Variant="Variant.Outlined" @bind-Value="currentCourseDetail.Name"
                          Label="Tên bài học" Required="true"></MudTextField>
        </MudItem>
        <br />
        <MudItem>
            <MudSelect T="Guid" Label="Thuộc khóa học" Required="true" @bind-Value="currentCourseDetail.CourseId">
                @foreach (var course in courses)
                {
                    <MudSelectItem Value="course.Id">@course.Name</MudSelectItem>
                }
            </MudSelect>
        </MudItem>
        <br />

        <MudItem>
            <MudSelect T="Guid" Label="Người tạo" Required="true" @bind-Value="currentCourseDetail.CreatorId">
                @foreach (var user in users)
                {
                    <MudSelectItem Value="user.Id">@user.Name</MudSelectItem>
                }
            </MudSelect>
        </MudItem>
        <br />

        <MudItem>
            <MudTextField Margin="Margin.Dense" Variant="Variant.Outlined" Lines="10" Placeholder="Có thể sử dụng các thẻ html"
                          @bind-Value="currentCourseDetail.Content" Label="Nội dung" Required="true"></MudTextField>
        </MudItem>
        <br />

        <MudItem Class="text-center">
            <MudButton Color="Color.Success" @onclick="EditAsync" Disabled="@(!formSuccess)">Update</MudButton>
            <MudButton Color="Color.Dark">
                <MudLink Color="Color.Dark" Underline="Underline.None" Href="admin/course-detail-manager">Quay lại</MudLink>
            </MudButton>
        </MudItem>
    </MudForm>
</MudPaper>


@code {

        [Parameter]
        public string ID { get; set; }

    protected bool formSuccess { get; set; }

    protected List<Course> courses { get; set; } = new List<Course>();

    protected List<CourseDetail> courseDetails { get; set; } = new List<CourseDetail>();

    protected CourseDetail currentCourseDetail { get; set; } = new CourseDetail();

    protected List<User> users { get; set; } = new List<User>();

    protected override void OnInitialized()
    {
        courses = CourseRepository.GetAllCourse();
        courseDetails = CourseDetailRepository.GetAllCourseDetail();
        users = UserRepository.GetUser();
        currentCourseDetail = courseDetails.FirstOrDefault(x => x.Id.ToString() == this.ID);

    }

    protected void Add()
    {
        if (currentCourseDetail is not null)
        {
            CourseDetailRepository.AddCourseDetail(currentCourseDetail);
            currentCourseDetail = new();
        }
    }

    protected async Task EditAsync()
    {
        CourseDetailRepository.UpdateCourseDetail(currentCourseDetail);
        await JSRuntime.InvokeVoidAsync("RedirectToCourseDetail");
    }
}
