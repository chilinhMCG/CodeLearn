@page "/admin/course/add-new"
@attribute [Authorize(Roles = "Admin")]
@inject ICourseTypeRepository CourseTypeRepository
@inject ICourseRepository CourseRepository
@inject ISnackbar Snackbar
@inject IWebHostEnvironment Environment
@inject NavigationManager Navigation

<MudPaper Class="p-4">
    <MudItem>
        <MudText Class="text-center" Color="Color.Success" Typo="Typo.h3">Thêm khóa học mới</MudText>
    </MudItem>
</MudPaper>
<br />
<MudPaper Class="m-auto p-4">
    <MudForm Model="_newCourse" @bind-IsValid="@_formSuccess">
        <MudItem>
            <MudTextField Margin="Margin.Dense" Variant="Variant.Outlined" @bind-Value="_newCourse.Name"
                          Label="Tên khóa học" Required="true"></MudTextField>
        </MudItem>
        <br />


        <MudItem>
            <MudTextField Margin="Margin.Dense" Variant="Variant.Outlined" @bind-Value="_newCourse.Author"
                          Label="Tác giả" Required="true"></MudTextField>
        </MudItem>
        <br />


        <MudItem>
            <MudSelect T="Guid" Label="Thuộc loại khóa học" Required="true" @bind-Value="_newCourse.CourseTypeId">
                @foreach (var item in _courseTypes)
                {   
                    <MudSelectItem Value="item.Id">@item.Name</MudSelectItem>
                }
            </MudSelect>
        </MudItem>
        <br />


        <MudItem>
            <MudText Typo="Typo.caption">Thumbnail</MudText><br />
            <InputFile id="file-input" OnChange="_imgCourseFileAsync" accept=".jpg, .jpeg"></InputFile>
            
        </MudItem>
        <br />


        <MudItem>
            <MudNumericField Margin="Margin.Dense" Variant="Variant.Outlined" @bind-Value="_newCourse.Rating"
                             Label="Rating" Min="0" Max="5" Required="true" Placeholder="Rating từ 0 đến 5"></MudNumericField>
        </MudItem>
        <br />


        <MudItem>
            <MudSelect T="CourseStatusEnum" Label="Status" Required="true" @bind-Value="_newCourse.Status">
                <MudSelectItem Value="CourseStatusEnum.Free" />
                <MudSelectItem Value="CourseStatusEnum.Block" />
                <MudSelectItem Value="CourseStatusEnum.Updating" />
                <MudSelectItem Value="CourseStatusEnum.Cancel" />
            </MudSelect>
        </MudItem>
        <br />


        <MudItem>
            <MudTextField Margin="Margin.Dense" Variant="Variant.Outlined" @bind-Value="_newCourse.Description"
                          Label="Mô tả" Lines="10" Required="true"></MudTextField>
        </MudItem>
        <br />



        <MudItem Class="text-center">
            <MudButton Color="Color.Success" @onclick="_addCourse" Disabled="@(!_formSuccess)">Thêm</MudButton>
            <MudButton Color="Color.Dark">
                <MudLink Color="Color.Dark" Underline="Underline.None" Href="admin/course-manager">Quay lại</MudLink>
            </MudButton>
        </MudItem>
    </MudForm>

</MudPaper>


@code {

    private bool _formSuccess { get; set; }

    private Course _newCourse { get; set; } = new();

    private List<CourseType> _courseTypes { get; set; }

    protected override void OnInitialized()
    {
        _courseTypes = CourseTypeRepository.GetAllCourseType();
    }


    private void _addCourse()
    {
        if (_newCourse is not null)
        {
            CourseRepository.AddCourse(_newCourse);
            Snackbar.Add("Thêm thành công!", Severity.Success);
            Navigation.NavigateTo("/admin/course-manager");
        }
    }

    public string text { get; set; }

    private async Task _imgCourseFileAsync(InputFileChangeEventArgs e)
    {
        _newCourse.Thumbnail = e.File.Name;

        var path = Path.Combine(Environment.ContentRootPath, "wwwroot\\images\\CoursesImg", e.File.Name);
        await using FileStream fs = new(path, FileMode.OpenOrCreate);
        await e.File.OpenReadStream().CopyToAsync(fs);
    }

}
