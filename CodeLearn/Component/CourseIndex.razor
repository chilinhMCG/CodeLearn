@page "/course/{id}"
@inject ICourseDetailRepository CourseDetailRepository
@inject ICourseRepository CourseRepository
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject NavigationManager Navigation

<MudPaper Class="d-flex justify-space-around p-4">
    <MudItem Style="float:left; width:20%">
        <MudText Typo="Typo.h4">@_currentCourse.Name</MudText>
        <MudText Typo="Typo.subtitle1">
            @_currentCourse.Author
            <MudRating @bind-SelectedValue="@_currentCourse.IntAverageRate" Size="Size.Small"></MudRating> 
            @_currentCourse.RateCount vote(s)
            <AuthorizeView Roles="Admin">
                <MudButton Color="Color.Error" Variant="Variant.Filled" @onclick="_deleteCourseAsync">Delete</MudButton>
                <MudButton Color="Color.Dark" Style="text-decoration:none" Variant="Variant.Filled" Link="@($"/account/course/edit/{_currentCourse.Id}")">Edit</MudButton>
            </AuthorizeView>
        </MudText>

    </MudItem>

    <MudDivider Vertical="true" FlexItem="true" Class="mr-3" />
    <MudItem Style="float:right; width:80%">
        <MudText Align="Align.Justify">
            @((MarkupString) _currentCourse.Description)
        </MudText>
    </MudItem>

</MudPaper>
<br />
<!-- bai hoc -->
<MudPaper Class="d-flex justify-space-around p-4">
    <MudItem Style="width:600px">
        @foreach (var item in _courseDetails)
        {
            <MudCard Style="width: 150px; float:left;" Class="m-3 text-center">
                <MudCardContent>
                    <MudLink Underline="Underline.None" Href="@($"/course-detail/{item.Id}")">@item.Name</MudLink>
                </MudCardContent>
            </MudCard>
        }
    </MudItem>
</MudPaper>



@code {
    [Parameter]
    public string Id { get; set; }

    private List<Course> _courses { get; set; } = new List<Course>();

    private Course _currentCourse { get; set; } = new Course();

    private List<CourseDetail> _courseDetails { get; set; } = new List<CourseDetail>();

    protected override void OnInitialized()
    {
        _courses = CourseRepository.GetAllCourse();
        _currentCourse = _courses.FirstOrDefault(x => x.Id.ToString() == this.Id);
        _courseDetails = CourseDetailRepository.GetAllCourseDetailsByCourseID(this.Id);
    }


    private async Task _deleteCourseAsync()
    {
        var dialog = DialogService.Show<DeleteDialog>("Xóa khóa học");
        var result = await dialog.Result;

        if (!result.Cancelled)
        {
            if (_courseDetails.Any(x => x.CourseId == _currentCourse.Id))
            {
                Snackbar.Add("Bạn cần phải xóa tất cả bài học trong khóa này trước!", Severity.Warning);
            }
            else
            {
                CourseRepository.DeleteCourse(_currentCourse);
                Snackbar.Add("Xóa thành công", Severity.Success);
            }
        }

        Navigation.NavigateTo("/");
    }


}
